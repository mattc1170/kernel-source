From 21949256dc9c57a3f143ab692de59d548eee20d2 Mon Sep 17 00:00:00 2001
From: Hong Liu <hong.liu@intel.com>
Date: Thu, 7 Jul 2016 14:25:51 +0800
Subject: [PATCH 135/143] Revert "[VPG]: drm/i915: share ppgtt across contexts"

This reverts commit d02374af6340e00924b030a9e3474a010e80707d.
Commit was pushed by mistake.
---
 drivers/gpu/drm/i915/i915_gem_context.c |   30 +++++-------------------------
 include/uapi/drm/i915_drm.h             |    1 -
 2 files changed, 5 insertions(+), 26 deletions(-)

Index: linux-4.4/drivers/gpu/drm/i915/i915_gem_context.c
===================================================================
--- linux-4.4.orig/drivers/gpu/drm/i915/i915_gem_context.c
+++ linux-4.4/drivers/gpu/drm/i915/i915_gem_context.c
@@ -896,7 +896,7 @@ int i915_gem_context_create_ioctl(struct
 	struct drm_i915_gem_context_create *args = data;
 	struct drm_i915_file_private *file_priv = file->driver_priv;
 	struct intel_context *ctx;
-	int ret = 0;
+	int ret;
 
 	if (!contexts_enabled(dev))
 		return -ENODEV;
@@ -906,34 +906,14 @@ int i915_gem_context_create_ioctl(struct
 		return ret;
 
 	ctx = i915_gem_create_context(dev, file_priv);
-	if (IS_ERR(ctx)) {
-		ret = PTR_ERR(ctx);
-		goto out;
-	}
-
-	if (args->pad == I915_GEM_CONTEXT_SHARE_PPGTT) {
-		struct intel_context *share_ctx;
-
-		share_ctx = i915_gem_context_get(file_priv, args->ctx_id);
-		if (IS_ERR(share_ctx)) {
-			ret = PTR_ERR(share_ctx);
-			goto out_free_ctx;
-		}
-
-		i915_ppgtt_get(share_ctx->ppgtt);
-		i915_ppgtt_put(ctx->ppgtt);
-		ctx->ppgtt = share_ctx->ppgtt;
-	}
+	mutex_unlock(&dev->struct_mutex);
+	if (IS_ERR(ctx))
+		return PTR_ERR(ctx);
 
 	args->ctx_id = ctx->user_handle;
 	DRM_DEBUG_DRIVER("HW context %d created\n", args->ctx_id);
 
-out_free_ctx:
-	idr_remove(&file_priv->context_idr, ctx->user_handle);
-	i915_gem_context_unreference(ctx);
-out:
-	mutex_unlock(&dev->struct_mutex);
-	return ret;
+	return 0;
 }
 
 int i915_gem_context_destroy_ioctl(struct drm_device *dev, void *data,
Index: linux-4.4/include/uapi/drm/i915_drm.h
===================================================================
--- linux-4.4.orig/include/uapi/drm/i915_drm.h
+++ linux-4.4/include/uapi/drm/i915_drm.h
@@ -1096,7 +1096,6 @@ struct drm_i915_gem_wait {
 	__s64 timeout_ns;
 };
 
-#define I915_GEM_CONTEXT_SHARE_PPGTT 1
 struct drm_i915_gem_context_create {
 	/*  output: id of new context*/
 	__u32 ctx_id;
